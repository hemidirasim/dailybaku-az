import { config } from 'dotenv';
import { resolve } from 'path';
import { PrismaClient } from '@prisma/client';
import { Pool } from 'pg';
import { PrismaPg } from '@prisma/adapter-pg';

// Load .env.local file
config({ path: resolve(__dirname, '../.env.local') });

// Initialize Prisma Client
const databaseUrl = process.env.DATABASE_URL;
if (!databaseUrl) {
  throw new Error('DATABASE_URL environment variable is not set');
}

const pool = new Pool({
  connectionString: databaseUrl,
});

const adapter = new PrismaPg(pool);
const prisma = new PrismaClient({
  adapter,
});

// Kateqoriya a√ßar s√∂zl…ôri
const categoryKeywords: Record<string, string[]> = {
  siyaset: [
    'siyas…ôt', 'siyasi', 'prezident', 'ba≈ü nazir', 'nazir', 'parlament', 'm…ôclis',
    'se√ßki', 'partiya', 'h√∂kum…ôt', 'd√∂vl…ôt', 'diplomat', 's…ôfir', 'beyn…ôlxalq',
    'tramp', 'biden', 'putin', '…ôrd–æƒüan', 'ukrayna', 'rusiya', 'nato', 'avropa',
    'm√ºqavil…ô', 'protokol', 'g√∂r√º≈ü', 'samit', 'konfrans', 'b…ôyanat', 'a√ßƒ±qlama',
    'q…ôrar', 'razƒ±la≈üma', 'm√ºzakir…ô', 'm…ôlumat', 'x…ôb…ôr', 'political', 'politics',
    'president', 'minister', 'government', 'parliament', 'election', 'party', 'diplomat',
    'international', 'trump', 'biden', 'putin', 'ukraine', 'russia', 'nato', 'europe',
    'treaty', 'protocol', 'meeting', 'summit', 'conference', 'statement', 'decision',
    'agreement', 'discussion'
  ],
  biznes: [
    'biznes', 'iqtisadi', 'iqtisadiyyat', 'ekonomi', 'ekonomik', 'bazar', 'sah…ô',
    'investisiya', 'investor', '≈üirk…ôt', 'korporasiya', 'bank', 'maliyy…ô', 'valyuta',
    'dollar', 'euro', 'neft', 'qaz', 'enerji', 's…ônaye', 'istehsal', 'ixrac', 'idxal',
    'biznes', 'business', 'economy', 'economic', 'market', 'investment', 'investor',
    'company', 'corporation', 'bank', 'finance', 'currency', 'dollar', 'euro', 'oil',
    'gas', 'energy', 'industry', 'production', 'export', 'import'
  ],
  texno: [
    'texnologiya', 'texno', 'texnik', 'komp√ºter', 'kompyuter', 'telefon', 'smartfon',
    'internet', 'onlayn', 'digital', 'r…ôq…ômsal', 'ai', 'artificial intelligence',
    's√ºni intellekt', 'robot', 'avtomatla≈üdƒ±rma', 'proqram', 't…ôtbiq', 'app',
    'startap', 'innovasiya', 'texnologiya', 'technology', 'tech', 'computer', 'phone',
    'smartphone', 'internet', 'online', 'digital', 'ai', 'artificial intelligence',
    'robot', 'automation', 'software', 'application', 'app', 'startup', 'innovation'
  ],
  avto: [
    'avtomobil', 'avto', 'ma≈üƒ±n', 'n…ôqliyyat', 'yol', 's√ºr√ºc√º', 'avtomobil',
    'bmw', 'mercedes', 'toyota', 'tesla', 'elektrik', 'elektrikli', 'benzin',
    'dizel', 'motor', 'avtomobil', 'car', 'automobile', 'vehicle', 'transport',
    'road', 'driver', 'bmw', 'mercedes', 'toyota', 'tesla', 'electric', 'petrol',
    'diesel', 'engine'
  ],
  idman: [
    'idman', 'idman√ßƒ±', 'futbol', 'basketbol', 'voleybol', 'tennis', '√ºzg√º√ß√ºl√ºk',
    'atletika', 'c√ºdo', 'boks', 'gimnastika', 'olimpiya', '√ßempionat', 'turnir',
    'komanda', 'oyun√ßu', 'm…ô≈üq', 'idman', 'sport', 'sports', 'football', 'basketball',
    'volleyball', 'tennis', 'swimming', 'athletics', 'judo', 'boxing', 'gymnastics',
    'olympic', 'championship', 'tournament', 'team', 'player', 'training'
  ],
  seyahet: [
    's…ôyah…ôt', 'turizm', 'turist', 's…ôf…ôr', 'yol', 'otell…ôr', 'u√ßu≈ü', 't…ôyyar…ô',
    'g…ômi', 'qatar', 'mehmanxana', 'kurort', 'istirah…ôt', 'g…ôzinti', 'g√∂r√º≈ü',
    'm…ôkan', '≈ü…ôh…ôr', '√∂lk…ô', 'travel', 'tourism', 'tourist', 'trip', 'journey',
    'flight', 'plane', 'ship', 'train', 'hotel', 'resort', 'vacation', 'sightseeing',
    'place', 'city', 'country'
  ],
  cemiyyet: [
    'c…ômiyy…ôt', 'h…ôyat', 'lifestyle', 'life style', 'moda', 'geyim', 'dizayn',
    'dekorasiya', 'ev', 'm…ôtb…ôx', 'yem…ôk', 'saƒülamlƒ±q', 'fitness', 'idman',
    'qidalanma', 'diyet', 'g√∂z…ôllik', 'kosmetika', 'm…ôclis', 'sosial', 'society',
    'lifestyle', 'life style', 'fashion', 'clothing', 'design', 'decoration',
    'home', 'kitchen', 'food', 'health', 'fitness', 'sport', 'nutrition', 'diet',
    'beauty', 'cosmetics', 'social'
  ],
  tehsil: [
    't…ôhsil', 'm…ôkt…ôb', 'universitet', 't…ôl…ôb…ô', 'm√º…ôllim', 'd…ôrs', 'imtahan',
    't…ôdris', 't…ôlim', 't…ôhsil', 'education', 'school', 'university', 'student',
    'teacher', 'lesson', 'exam', 'teaching', 'training', 'education'
  ],
  dunya: [
    'd√ºnya', 'beyn…ôlxalq', 'qlobal', 'xarici', 'x…ôb…ôr', 'hadis…ô', 't…ôdbir',
    'world', 'international', 'global', 'foreign', 'news', 'event', 'incident'
  ]
};

async function assignCategoriesToArticles() {
  try {
    console.log('üîç Kateqoriyasƒ± olmayan x…ôb…ôrl…ôri axtarƒ±r...\n');

    // B√ºt√ºn kateqoriyalarƒ± y√ºkl…ô
    const categories = await prisma.category.findMany({
      include: {
        translations: true,
      },
    });

    console.log(`üìã Tapƒ±lan kateqoriyalar: ${categories.length}\n`);

    // Kateqoriyasƒ± null olan x…ôb…ôrl…ôri tap
    const articlesWithoutCategory = await prisma.article.findMany({
      where: {
        categoryId: null,
        deletedAt: null,
      },
      include: {
        translations: true,
      },
    });

    console.log(`üì∞ Kateqoriyasƒ± olmayan x…ôb…ôr sayƒ±: ${articlesWithoutCategory.length}\n`);

    if (articlesWithoutCategory.length === 0) {
      console.log('‚úÖ B√ºt√ºn x…ôb…ôrl…ôrin kateqoriyasƒ± var!');
      return;
    }

    let assignedCount = 0;
    let notAssignedCount = 0;

    for (const article of articlesWithoutCategory) {
      const azTranslation = article.translations.find(t => t.locale === 'az');
      const enTranslation = article.translations.find(t => t.locale === 'en');

      const title = (azTranslation?.title || enTranslation?.title || '').toLowerCase();
      const content = (azTranslation?.content || enTranslation?.content || '').toLowerCase();
      const text = `${title} ${content}`;

      // H…ôr bir kateqoriya √º√ß√ºn uyƒüunluq yoxla
      let bestMatch: { categoryId: string; score: number; slug: string } | null = null;

      for (const category of categories) {
        const categorySlug = category.slug;
        const keywords = categoryKeywords[categorySlug] || [];

        if (keywords.length === 0) continue;

        let score = 0;
        for (const keyword of keywords) {
          const keywordLower = keyword.toLowerCase();
          if (text.includes(keywordLower)) {
            score++;
            // Ba≈ülƒ±qda olarsa daha √ßox bal ver
            if (title.includes(keywordLower)) {
              score += 2;
            }
          }
        }

        if (score > 0 && (!bestMatch || score > bestMatch.score)) {
          bestMatch = {
            categoryId: category.id,
            score,
            slug: categorySlug,
          };
        }
      }

      if (bestMatch && bestMatch.score >= 2) {
        // Kateqoriyaya t…ôyin et
        await prisma.article.update({
          where: { id: article.id },
          data: {
            categoryId: bestMatch.categoryId,
          },
        });

        const articleTitle = azTranslation?.title || enTranslation?.title || 'Nam…ôlum';
        console.log(`‚úÖ "${articleTitle.substring(0, 50)}..." ‚Üí ${bestMatch.slug} (score: ${bestMatch.score})`);
        assignedCount++;
      } else {
        const articleTitle = azTranslation?.title || enTranslation?.title || 'Nam…ôlum';
        console.log(`‚ùå "${articleTitle.substring(0, 50)}..." ‚Üí Uyƒüun kateqoriya tapƒ±lmadƒ±`);
        notAssignedCount++;
      }
    }

    console.log(`\nüìä N…ôtic…ô:`);
    console.log(`   ‚úÖ T…ôyin edildi: ${assignedCount}`);
    console.log(`   ‚ùå T…ôyin edilm…ôdi: ${notAssignedCount}`);
    console.log(`\n‚úÖ Proses tamamlandƒ±!`);
  } catch (error: any) {
    console.error('‚ùå X…ôta:', error);
    throw error;
  } finally {
    await pool.end();
    await prisma.$disconnect();
  }
}

assignCategoriesToArticles()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error('Script failed:', error);
    process.exit(1);
  });

